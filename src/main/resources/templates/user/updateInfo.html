<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>Toty</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="Free HTML Templates" name="keywords"/>
    <meta content="Free HTML Templates" name="description"/>

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
            rel="stylesheet">
    <!-- Font Awesome -->
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
            rel="stylesheet"
    />
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
            integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    />



    <!--Sweet Alert2-->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>

    <!-- Customized Bootstrap Stylesheet -->
    <link href="/css/style.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/globals.css"/>
    <link rel="stylesheet" href="/css/register.css" type="text/css"/>
    <style>
        #links-container {
        display: flex;
        margin: auto;
        text-align: start;
        align-items: center;
        justify-content: space-between;
        flex-direction: row-reverse;
        }

    </style>
</head>

<body>
<!-- Topbar Start -->
<div class="container-fluid">
    <div class="row bg-secondary py-2 px-xl-5">
        <div class="col-lg-6 d-none d-lg-block">
        </div>
    </div>
</div>
<div class="row align-items-center py-3 px-xl-5">
    <div class="col-lg-3 d-none d-lg-block">
        <a href="/home">
            <img src="/img/logo.png" style="margin-left: 25%; width: 55%;">
        </a>
    </div>
</div>
<!-- Topbar End -->

<!-- Navbar Start -->
<div class="container-fluid mb-2">
    <div class="row px-xl-5">
    </div>
</div>
<!-- Navbar End -->

<div class="container-fluid">
    <div class="row"
         style="justify-content: space-between; flex-wrap: nowrap; margin: auto;">
        <div class="col-12 mb-0">
            <div class="mb-8">
                <h4 class="font-weight-semi-bold mb-5"
                    style="font-size: 20px; text-align: center; color: darkgray;">회원정보 수정</h4>
                <form action="/api/users/update" id="updateForm" method="post" style="color: black; font-weight: 400;" onsubmit="return false">
                    <div class="row">

                        <div class="col-md-7 form-group">
                            <label>프로필 이미지</label>
                            <div class="col-md-4">
                                <a class="img-gal">
                            </div>
                            <div class="single-gallery-image" style="background: url(img/elements/g2.jpg)"></div>
                            </a>
                            <input class="form-control" name="profileImage" type="file" id="formFile"
                                   placeholder="프로필 이미지를 등록해 주세요."
                                   style="padding-top: 0.5rem;">
                        </div>

                        <input type="hidden" th:value="${userInfo.id}" name="uid" id="uid">

                        <div class="col-md-7 form-group">
                            <label>닉네임</label>
                            <div class="check-group">
                                <input class="form-control" name="nickname" id="nickname" type="text"
                                       placeholder="사용하실 닉네임을 입력해 주세요." style=" width: 80%;" th:value="${userInfo.nickname}">
                                <button class="btn btn-info" id="checkNicknameBtn" type="button"
                                        style="padding: 0;" data-available="true">중복확인
                                </button>
                            </div>
                        </div>

                        <div class="col-md-7 form-group">
                            <label>현재 비밀번호</label>
                            <input class="form-control" type="password" id="currentPassword" name="currentPassword"
                                   placeholder="현재 비밀번호를 입력해 주세요." autocomplete="off">
                        </div>

                        <div class="col-md-7 form-group">
                            <label>새 비밀번호</label>
                            <input class="form-control" type="password" id="newPassword" name="newPassword"
                                   placeholder="새 비밀번호를 입력해 주세요. (최소 8자)" autocomplete="off">
                            <small style="color: #6c757d;">비밀번호를 변경하지 않으려면 비워두세요.</small>
                        </div>

                        <div class="col-md-7 form-group">
                            <label>새 비밀번호 확인</label>
                            <input class="form-control" type="password" id="confirmPassword" name="confirmPassword"
                                   placeholder="새 비밀번호를 다시 입력해 주세요." autocomplete="off">
                            <font id="pwdCheck" style="font-size: 12px; display: block; margin-top: 5px;"></font>
                        </div>
                        <div class="col-md-7 form-group custom-control">
                            <label>수신 동의</label>
                            <div class="switch-wrap d-flex justify-content-between">
                                <label>SMS 수신 동의</label>
                                <!-- <div class="primary-checkbox"> -->
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" id="sms-subscribe" name="smsSubscribed" class="custom-control-input" th:checked="${userInfo.smsSubscribed}">
                                    <label for="sms-subscribe" class="custom-control-label"></label>
                                </div>
                            </div>
                            <div class="switch-wrap d-flex justify-content-between">
                                <label>메일 수신 동의</label>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" id="email-subscribe" name="emailSubscribed" class="custom-control-input" th:checked="${userInfo.emailSubscribed}">
                                    <label for="email-subscribe" class="custom-control-label"></label>
                                </div>
                            </div>
                            <div class="switch-wrap d-flex justify-content-between">
                                <label>앱 알림 수신 동의</label>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" id="noti-subscribe" name="notificationAllowed" class="custom-control-input" th:checked="${userInfo.notificationAllowed}">
                                    <label for="noti-subscribe" class="custom-control-label"></label>
                                </div>
                            </div>
                        </div>

                </form>

                <div class="col-7 pt-3">
                    <button type="button" id="formSubmit" class="btn btn-info" style="width: 100%;">저장</button>
                </div>
            </div>


        </div>
    </div>

</div>


<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>

<script src="/lib/easing/easing.min.js"></script>
<script src="/lib/owlcarousel/owl.carousel.min.js"></script>


<!-- Template Javascript -->
<!--<script src="/js/main.js"></script>-->
<script>

    // sweetalert 버튼 스타일 설정
    const swalConfig = {confirmButtonColor: '#1f9bcf'};

      document
      .getElementById('checkNicknameBtn')
      .addEventListener('click', isNicknameAvailable);


      // 닉네임 중복 검사 로직
      // 1. 중복검사 후 사용 가능한 닉네임일 경우 사용 또는 취소를 선택할 수 있음
      // 2. 사용 버튼 클릭 시 중복확인 버튼이 비활성화 상태로 변경되며, 닉네임 중복확인 여부를 확인하는 속성 값이 true로 변경 됨(태그에 속성 값은 false로 미리 부여해 둠)
      // 3. 취소 버튼 클릭 시 중복확인 버튼 활성화 유지, 중복여부를 확인 하는 속성 값도 false로 유지 됨
      // 4. 사용 버튼 클릭 후 중복확인 버튼이 비활성화 되었으나, 사용자가 새로운 닉네임을 input에 입력할 경우 입력을 감지해 중복확인 버튼 활성화, 속성값 false로 변경 됨
      // 5. 항목별 중복검사 실행 여부를 판단하는 속성 값이 각각 설정된 상태로 모든 값이 true가 아니라면 Form 제출이 불가능 하도록 설정 함.
      // ** 속성 명: data-available **

      function isNicknameAvailable() {
        let nickname = document.getElementById('nickname').value.trim();

        if (!nickname) {
          Swal.fire({
            icon: 'warning',
            text: '닉네임을 입력해 주세요.',
            ...swalConfig,
          });
          return;
        }

        console.log('닉네임 중복 확인 시작:', nickname);

        $.ajax({
          url: '/api/users/check-nickname',
          type: 'GET',
          data: {nickname: nickname},
          dataType: 'json',
          success: function (response) {
            console.log('닉네임 중복 확인 응답:', response);

            if (!response) {
              Swal.fire({
                icon: 'error',
                text: '서버 응답이 올바르지 않습니다.',
                ...swalConfig,
              });
              return;
            }

            // 성공 응답 처리 (status가 200이면 사용 가능한 닉네임)
            if (response.status === 200) {
              Swal.fire({
                icon: 'success',
                text: response.message || '사용할 수 있는 닉네임입니다.',
                showCancelButton: true,
                cancelButtonColor: '#d33',
                confirmButtonText: '사용',
                cancelButtonText: '취소',
                ...swalConfig,
              }).then((result) => {
                if (result.isConfirmed) {
                  console.log('닉네임 사용 확정');
                  // 중복검사 실행 여부를 확인하는 속성 값!
                  document
                  .getElementById('checkNicknameBtn')
                  .setAttribute('data-available', 'true');
                  document
                  .getElementById('checkNicknameBtn')
                  .setAttribute('disabled', true);
                } else {
                  console.log('닉네임 사용 취소');
                }
              });
            } else {
              // 에러 응답 처리
              Swal.fire({
                icon: 'warning',
                text: response.message || '닉네임을 확인할 수 없습니다.',
                ...swalConfig,
              });
            }
          },
          error: function (xhr, status, error) {
            console.error('닉네임 중복 확인 에러:', error);
            console.error('XHR:', xhr);

            // 서버에서 에러 응답을 보낸 경우
            if (xhr.responseJSON) {
              Swal.fire({
                icon: 'warning',
                text: xhr.responseJSON.message || '이미 사용 중인 닉네임입니다.',
                ...swalConfig,
              });
            } else {
              Swal.fire({
                icon: 'error',
                text: '서버 응답이 올바르지 않습니다.',
                ...swalConfig,
              });
            }
          },
        });
      }

      // 닉네임 재입력 시 중복 검사 버튼 활성화
      document.getElementById('nickname').addEventListener('input', function () {
        if (document.getElementById('checkNicknameBtn').getAttribute('data-available')
            === 'true') {
          document.getElementById('checkNicknameBtn').removeAttribute('disabled');
          document
          .getElementById('checkNicknameBtn')
          .setAttribute('data-available', 'false');
        }
      });

      // 비밀번호 확인 검증
      document.getElementById('confirmPassword').addEventListener('keyup', function() {
        const newPwd = document.getElementById('newPassword').value;
        const confirmPwd = this.value;
        const pwdCheck = document.getElementById('pwdCheck');

        if (!newPwd && !confirmPwd) {
          pwdCheck.innerHTML = '';
          return;
        }

        if (newPwd !== confirmPwd) {
          pwdCheck.innerHTML = '비밀번호가 일치하지 않습니다';
          pwdCheck.style.color = 'red';
        } else {
          pwdCheck.innerHTML = '비밀번호가 일치합니다';
          pwdCheck.style.color = 'green';
        }
      });

      // 새 비밀번호 입력 시에도 확인
      document.getElementById('newPassword').addEventListener('keyup', function() {
        const newPwd = this.value;
        const confirmPwd = document.getElementById('confirmPassword').value;
        const pwdCheck = document.getElementById('pwdCheck');

        if (!newPwd && !confirmPwd) {
          pwdCheck.innerHTML = '';
          return;
        }

        if (confirmPwd && newPwd !== confirmPwd) {
          pwdCheck.innerHTML = '비밀번호가 일치하지 않습니다';
          pwdCheck.style.color = 'red';
        } else if (confirmPwd && newPwd === confirmPwd) {
          pwdCheck.innerHTML = '비밀번호가 일치합니다';
          pwdCheck.style.color = 'green';
        } else {
          pwdCheck.innerHTML = '';
        }
      });


      document.getElementById('formSubmit').addEventListener('click', checkForm);

      function checkForm() {

        console.log('checkForm');

        // 비밀번호 변경 검증
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // 비밀번호 변경을 원하는 경우
        if (newPassword || confirmPassword) {
          if (!currentPassword) {
            Swal.fire({
              icon: 'warning',
              text: '비밀번호를 변경하려면 현재 비밀번호를 입력해주세요.',
              ...swalConfig,
            });
            return false;
          }

          if (newPassword !== confirmPassword) {
            Swal.fire({
              icon: 'warning',
              text: '새 비밀번호와 비밀번호 확인이 일치하지 않습니다.',
              ...swalConfig,
            });
            return false;
          }

          if (newPassword.length < 8) {
            Swal.fire({
              icon: 'warning',
              text: '새 비밀번호는 최소 8자 이상이어야 합니다.',
              ...swalConfig,
            });
            return false;
          }
        }

        // basicInfo 객체 생성 (배열 초기화 필수!)
        const basicInfo = {
          nickname: document.querySelector('#nickname').value,
          subscriptionAllowed: []
        };

        // 체크박스 값에 따라 배열에 추가
        if (document.getElementById('email-subscribe').checked) {
          basicInfo.subscriptionAllowed.push('email');
        }
        if (document.getElementById('sms-subscribe').checked) {
          basicInfo.subscriptionAllowed.push('sms');
        }
        if (document.getElementById('noti-subscribe').checked) {
          basicInfo.subscriptionAllowed.push('notification');
        }

        // 비밀번호 변경 시에만 basicInfo에 추가
        if (newPassword) {
          basicInfo.currentPassword = currentPassword;
          basicInfo.newPassword = newPassword;
        }

        console.log('BasicInfo 내용:', basicInfo);

        // FormData 생성
        const formData = new FormData();

        // basicInfo를 JSON Blob으로 추가
        formData.append(
          'basicInfo',
          new Blob([JSON.stringify(basicInfo)], {
            type: 'application/json',
          })
        );

        // 프로필 이미지 파일이 있으면 추가
        const profileImageFile = document.getElementById('formFile').files[0];
        if (profileImageFile) {
          formData.append('profileImage', profileImageFile);
        }

        console.log('FormData 내용:');
        for (let [key, value] of formData.entries()) {
          console.log(key, ':', value);
        }

        // let file = document.getElementById('formFile').files[0];
        // if (file) {
        //   formData.append('profileImage', file);
        // }

        if (document.getElementById('checkNicknameBtn').getAttribute('data-available')
            === 'false') {
          Swal.fire({
            icon: 'warning',
            text: '닉네임 중복 확인을 해주세요.',
            ...swalConfig,
          });
          return false;
        }





        fetch('/api/users/update', {
          method: 'POST',
          body: formData,
        })
        .then((response) => {
          return response.json().then(data => {
            if (response.ok) {
              return data;
            } else {
              // 에러 응답 처리
              throw {
                status: data.status,
                message: data.errorMessage || data.message || '업데이트 실패!'
              };
            }
          });
        })
        .then((data) => {
          console.log('업데이트 성공:', data);
          Swal.fire({
            icon: 'success',
            text: '회원정보가 수정되었습니다.',
            ...swalConfig,
          }).then(() => {
            if (window.opener && !window.opener.closed) {
              window.opener.location.reload(); // 부모 창 새로고침
            }
            window.close(); // 팝업창 닫기
          });
        })
        .catch((error) => {
          console.error('Error:', error);

          // 에러 메시지 표시
          const errorMessage = error.message || '업데이트 실패! 다시 시도해 주세요.';

          Swal.fire({
            icon: 'error',
            title: '오류',
            text: errorMessage,
            ...swalConfig,
          });
        });

      }
</script>
</body>

</html>
        