<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <title>Toty - 회원가입</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet"/>

    <!-- Sweet Alert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>

    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Noto Sans KR', sans-serif;
          background-color: #f8f9fa;
          padding: 20px;
        }

        .container {
          max-width: 500px;
          margin: 0 auto;
          background: white;
          padding: 40px 30px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo {
          text-align: center;
          margin-bottom: 30px;
        }

        .logo h1 {
          font-size: 36px;
          font-weight: 700;
          color: #333;
          letter-spacing: 2px;
        }

        .logo h1 span {
          display: inline-block;
        }

        .page-title {
          text-align: center;
          color: #999;
          font-size: 14px;
          margin-bottom: 40px;
          letter-spacing: 2px;
        }

        .form-group {
          margin-bottom: 20px;
        }

        .form-group label {
          display: block;
          margin-bottom: 8px;
          color: #666;
          font-size: 14px;
          font-weight: 500;
        }

        .form-control {
          width: 100%;
          padding: 12px 15px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
          background-color: #f8f9fa;
          transition: border-color 0.3s;
        }

        .form-control:focus {
          outline: none;
          border-color: #17a2b8;
          background-color: white;
        }

        .form-control::placeholder {
          color: #aaa;
        }

        .check-group {
          display: flex;
          gap: 10px;
        }

        .check-group .form-control {
          flex: 1;
        }

        .btn {
          padding: 12px 20px;
          border: none;
          border-radius: 4px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s;
        }

        .btn-info {
          background-color: #17a2b8;
          color: white;
          white-space: nowrap;
        }

        .btn-info:hover {
          background-color: #138496;
        }

        .btn-info:disabled {
          background-color: #6c757d;
          cursor: not-allowed;
        }

        .btn-primary {
          width: 100%;
          background-color: #17a2b8;
          color: white;
          padding: 15px;
          font-size: 16px;
          margin-top: 10px;
        }

        .btn-primary:hover {
          background-color: #138496;
        }

        .btn-primary:disabled {
          background-color: #6c757d;
          cursor: not-allowed;
          opacity: 0.6;
        }

        #chk {
          display: block;
          margin-top: 5px;
          font-size: 12px;
        }

        .check-group input[type="tel"] {
          width: calc(100% - 70px);
        }

        .check-group input[type="text"][maxlength="6"] {
          width: calc(100% - 70px);
        }
    </style>
</head>

<body>
<div class="container">
    <!-- Logo -->
    <div class="logo">
        <a href="/view/users/home">
            <img src="/favicon.ico" alt="TOTY Logo" style="max-width: 200px; height: auto;">
        </a>
    </div>

    <!-- Page Title -->
    <div class="page-title">회원가입</div>

    <!-- Form -->
    <form id="registerForm" method="post" onsubmit="return false">
        <!-- 이메일 -->
        <div class="form-group">
            <label>이메일</label>
            <div class="check-group">
                <input class="form-control" type="email" id="email" name="email"
                       placeholder="사용하실 이메일을 입력해 주세요." required>
                <button class="btn btn-info" id="checkEmailBtn" type="button" data-available="false">중복확인</button>
            </div>
        </div>

        <!-- 비밀번호 -->
        <div class="form-group">
            <label>비밀번호</label>
            <input class="form-control" id="pwd" name="password" type="password"
                   placeholder="사용하실 비밀번호를 입력해 주세요." autocomplete="off" required>
        </div>

        <!-- 비밀번호 재확인 -->
        <div class="form-group">
            <label>비밀번호 재확인</label>
            <input class="form-control" id="pwd2" name="pwd2" type="password"
                   placeholder="비밀번호를 다시 한 번 입력해 주세요." autocomplete="off" required>
            <font id="chk"></font>
        </div>

        <!-- 이름 -->
        <div class="form-group">
            <label>이름</label>
            <input class="form-control" type="text" id="username" name="username"
                   placeholder="실명을 입력해 주세요." required>
        </div>

        <!-- 닉네임 -->
        <div class="form-group">
            <label>닉네임</label>
            <div class="check-group">
                <input class="form-control" name="nickname" id="nickname" type="text"
                       placeholder="사용하실 닉네임을 입력해 주세요." required>
                <button class="btn btn-info" id="checkNicknameBtn" type="button" data-available="false">중복확인</button>
            </div>
        </div>

        <!-- 휴대폰 번호 -->
        <div class="form-group">
            <label>휴대폰 번호</label>
            <div class="check-group">
                <input class="form-control" id="phone" name="phoneNumber" type="tel"
                       placeholder="예시: 010-1234-5678" pattern="(01[016789]{1})-?[0-9]{3,4}-?[0-9]{4}">
                <button class="btn btn-info" id="authNumReq" type="button">인증</button>
            </div>
        </div>

        <!-- 인증번호 확인 -->
        <div class="form-group">
            <div class="check-group">
                <input class="form-control" type="text" maxlength="6" id="authNum"
                       placeholder="전송된 인증번호 6자리를 입력해 주세요." pattern="[0-9]+">
                <button class="btn btn-info" id="authNumRes" type="button" disabled>확인</button>
            </div>
        </div>

        <!-- 회원가입 버튼 -->
        <button type="submit" id="formSubmit" class="btn btn-primary">회원가입</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script>
    $(document).ready(function() {

      // 비밀번호 확인
      $('#pwd2').on('keyup', function() {
        const pwd = $('#pwd').val();
        const pwd2 = $(this).val();
        const chk = $('#chk');

        if(pwd !== pwd2) {
          chk.html('비밀번호가 일치하지 않습니다').css('color', 'red');
        } else {
          chk.html('비밀번호가 일치합니다').css('color', 'green');
        }
      });

      // 이메일 입력 시 중복 확인 상태 초기화
      $('#email').on('input', function() {
        $('#checkEmailBtn').attr('data-available', 'false');
        $('#checkEmailBtn').prop('disabled', false);
        checkFormValidity();
      });

      // 이메일 중복 확인
      $('#checkEmailBtn').on('click', function() {
        const email = $('#email').val();
        if(!email) {
          Swal.fire('오류', '이메일을 입력해주세요', 'error');
          return;
        }

        console.log('[SIGNUP] 이메일 중복 확인 요청:', email);

        $.ajax({
          url: '/api/users/check-email',
          method: 'GET',
          data: { email: email },
          success: function(response) {
            console.log('[SIGNUP] 이메일 중복 확인 성공:', response);
            Swal.fire('확인', '사용 가능한 이메일입니다', 'success');
            $('#checkEmailBtn').attr('data-available', 'true');
            $('#checkEmailBtn').prop('disabled', true);
            checkFormValidity();
          },
          error: function(error) {
            console.error('[SIGNUP] 이메일 중복 확인 실패:', error);
            Swal.fire('오류', error.responseJSON?.message || '이미 사용 중인 이메일입니다', 'error');
            $('#checkEmailBtn').attr('data-available', 'false');
            checkFormValidity();
          }
        });
      });

      // 닉네임 입력 시 중복 확인 상태 초기화
      $('#nickname').on('input', function() {
        $('#checkNicknameBtn').attr('data-available', 'false');
        $('#checkNicknameBtn').prop('disabled', false);
        checkFormValidity();
      });

      // 닉네임 중복 확인
      $('#checkNicknameBtn').on('click', function() {
        const nickname = $('#nickname').val();
        if(!nickname) {
          Swal.fire('오류', '닉네임을 입력해주세요', 'error');
          return;
        }

        console.log('[SIGNUP] 닉네임 중복 확인 요청:', nickname);

        $.ajax({
          url: '/api/users/check-nickname',
          method: 'GET',
          data: { nickname: nickname },
          success: function(response) {
            console.log('[SIGNUP] 닉네임 중복 확인 성공:', response);
            Swal.fire('확인', '사용 가능한 닉네임입니다', 'success');
            $('#checkNicknameBtn').attr('data-available', 'true');
            $('#checkNicknameBtn').prop('disabled', true);
            checkFormValidity();
          },
          error: function(error) {
            console.error('[SIGNUP] 닉네임 중복 확인 실패:', error);
            Swal.fire('오류', error.responseJSON?.message || '이미 사용 중인 닉네임입니다', 'error');
            $('#checkNicknameBtn').attr('data-available', 'false');
            checkFormValidity();
          }
        });
      });

      // 휴대폰 번호 입력 시 인증 상태 초기화
      $('#phone').on('input', function() {
        $('#authNumRes').attr('data-verified', 'false');
        $('#authNumRes').prop('disabled', true);
        $('#authNum').val('');
        checkFormValidity();
      });

      // 인증번호 요청
      $('#authNumReq').on('click', function() {
        const phone = $('#phone').val();
        if(!phone) {
          Swal.fire('오류', '휴대폰 번호를 입력해주세요', 'error');
          return;
        }

        const phonePattern = /^(01[016789]{1})-?[0-9]{3,4}-?[0-9]{4}$/;
        if(!phonePattern.test(phone)) {
          Swal.fire('오류', '올바른 휴대폰 번호 형식이 아닙니다', 'error');
          return;
        }

        // 하이픈 제거
        const phoneNumber = phone.replace(/-/g, '');
        console.log('[SIGNUP] SMS 인증번호 요청:', phoneNumber);

        $.ajax({
          url: '/api/users/authCode',
          method: 'POST',
          data: { phoneNumber: phoneNumber },
          success: function(response) {
            console.log('[SIGNUP] SMS 인증번호 전송 성공:', response);
            Swal.fire('전송 완료', '인증번호가 전송되었습니다', 'success');
            $('#authNumRes').prop('disabled', false);
            $('#authNumRes').attr('data-verified', 'false');
            checkFormValidity();
          },
          error: function(error) {
            console.error('[SIGNUP] SMS 인증번호 전송 실패:', error);
            Swal.fire('오류', error.responseJSON?.message || 'SMS 전송에 실패했습니다', 'error');
          }
        });
      });

      // 인증번호 확인
      $('#authNumRes').on('click', function() {
        const authNum = $('#authNum').val();
        if(!authNum || authNum.length !== 6) {
          Swal.fire('오류', '인증번호 6자리를 입력해주세요', 'error');
          return;
        }

        const phone = $('#phone').val();
        const phoneNumber = phone.replace(/-/g, '');
        console.log('[SIGNUP] 인증번호 확인 요청:', { phoneNumber, authNum });

        $.ajax({
          url: '/api/users/check-authCode',
          method: 'POST',
          data: {
            phoneNumber: phoneNumber,
            authCode: authNum
          },
          success: function(response) {
            console.log('[SIGNUP] 인증번호 확인 성공:', response);
            Swal.fire('확인 완료', '인증이 완료되었습니다', 'success');
            $('#authNumRes').attr('data-verified', 'true');
            $('#authNumRes').prop('disabled', true);
            checkFormValidity();
          },
          error: function(error) {
            console.error('[SIGNUP] 인증번호 확인 실패:', error);
            Swal.fire('오류', error.responseJSON?.message || '인증번호가 일치하지 않습니다', 'error');
            $('#authNumRes').attr('data-verified', 'false');
            checkFormValidity();
          }
        });
      });

      // 폼 유효성 검사 함수
      function checkFormValidity() {
        const emailChecked = $('#checkEmailBtn').attr('data-available') === 'true';
        const nicknameChecked = $('#checkNicknameBtn').attr('data-available') === 'true';
        const phoneVerified = $('#authNumRes').attr('data-verified') === 'true';
        const passwordMatch = $('#pwd').val() && $('#pwd2').val() && $('#pwd').val() === $('#pwd2').val();
        const allFieldsFilled = $('#email').val() && $('#pwd').val() && $('#pwd2').val() &&
                                $('#username').val() && $('#nickname').val() && $('#phone').val();

        console.log('[SIGNUP] 폼 유효성 검사:', {
          emailChecked,
          nicknameChecked,
          phoneVerified,
          passwordMatch,
          allFieldsFilled
        });

        // 모든 조건이 만족되면 회원가입 버튼 활성화
        if(emailChecked && nicknameChecked && phoneVerified && passwordMatch && allFieldsFilled) {
          $('#formSubmit').prop('disabled', false);
          console.log('[SIGNUP] ✅ 회원가입 버튼 활성화');
        } else {
          $('#formSubmit').prop('disabled', true);
          console.log('[SIGNUP] ❌ 회원가입 버튼 비활성화');
        }
      }

      // 모든 입력 필드에 변경 감지 추가
      $('#pwd, #pwd2, #username').on('input', checkFormValidity);

      // 폼 제출
      $('#registerForm').on('submit', function(e) {
        e.preventDefault();

        // 유효성 검사
        if($('#checkEmailBtn').attr('data-available') !== 'true') {
          Swal.fire('오류', '이메일 중복 확인을 해주세요', 'error');
          return false;
        }

        if($('#checkNicknameBtn').attr('data-available') !== 'true') {
          Swal.fire('오류', '닉네임 중복 확인을 해주세요', 'error');
          return false;
        }

        if($('#authNumRes').attr('data-verified') !== 'true') {
          Swal.fire('오류', '휴대폰 인증을 완료해주세요', 'error');
          return false;
        }

        if($('#pwd').val() !== $('#pwd2').val()) {
          Swal.fire('오류', '비밀번호가 일치하지 않습니다', 'error');
          return false;
        }

        // 회원가입 데이터
        const formData = {
          email: $('#email').val(),
          password: $('#pwd').val(),
          username: $('#username').val(),
          nickname: $('#nickname').val(),
          phoneNumber: $('#phone').val().replace(/-/g, '')
        };

        console.log('[SIGNUP] 회원가입 데이터:', formData);

        $.ajax({
          url: '/view/users/signup',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(formData),
          success: function(response) {
            console.log('[SIGNUP] 회원가입 성공:', response);
            Swal.fire('성공', '회원가입이 완료되었습니다', 'success').then(() => {
              window.location.href = response.redirectUrl || '/view/users/login';
            });
          },
          error: function(error) {
            console.error('[SIGNUP] 회원가입 실패:', error);
            Swal.fire('오류', error.responseJSON?.message || '회원가입에 실패했습니다', 'error');
          }
        });

        return false;
      });

      // 페이지 로드 시 초기 검사
      checkFormValidity();

    });
</script>
</body>
</html>