<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <title>TOTY_로그인2</title>

    <!-- Font Awesome -->
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
            rel="stylesheet"
    />
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
            integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    />
    <!-- Bootstrap CSS -->
    <link href="/css/bootstrap.css" rel="stylesheet"/>
    <!-- main css -->
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/user.css" type="text/css"/>
</head>
<body>
<header class="header_area">

    <div class="main_menu">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light w-100">
                <!-- Brand and toggle get grouped for better mobile display -->
                <a class="navbar-brand logo_h" href="/" style="margin: auto;">
                    <img src="/img/logo.png" style="width: 170px;" alt="logo" href="/"/>
                </a>
            </nav>
        </div>
    </div>
</header>


<div class="container">
    <div>
        <div class="section pt-5">
            <div class="row" style="justify-content: center;">
                <div class="col-lg-8 col-md-8">
                    <h3 class="mb-30 title_color" style="text-align: center;">안녕하세요!</h3>
                    <form id="logInForm" onsubmit="return false;">
                        <div class="mt-10">
                            <input type="text" name="email" placeholder="이메일" onfocus="this.placeholder = ''"
                                   onblur="this.placeholder = '이메일'"
                                   required class="single-input"

                            >
                        </div>
                        <div class="mt-10">
                            <input type="password" name="pwd" placeholder="비밀번호" onfocus="this.placeholder = ''"
                                   onblur="this.placeholder = '비밀번호'"
                                   required class="single-input"

                            >
                        </div>
                        <div class="mt-10">
                            <p class="sub text-uppercase" style="color: black;">
                                <i class="ti-help-alt" aria-hidden="true" style="margin: 1%;"></i>
                                <a href="/view/users/find-email">이메일 찾기</a> |
                                <a href="/view/users/reset-password">비밀번호 찾기</a>
                            </p>
                        </div>

                        <div class="mt-10">
                            <button type="submit" id="logInBtn" class="main_btn"
                                    style="width: 100%; font-size: medium;">로그인
                            </button>
                        </div>
                        <div class="mt-10">
                            <a href="/view/users/signup" class="genric-btn default radius"
                               style="width: 100%; font-size: medium;">회원가입</a>
                        </div>

                        <div class="mt-10">
                            <div class="col-lg-4 col-md-4"
                                 style="border-bottom: 1px solid lightgray; float: inline-start; height: 12px;"></div>
                            <div class="col-lg-4 col-md-4"
                                 style="float: inline-start; text-align: center; color: black;"><a href="#"
                                                                                                   style="color: black;">소셜
                                로그인</a>
                            </div>
                            <div class="col-lg-4 col-md-4"
                                 style="border-bottom: 1px solid lightgray; float: inline-end;height: 12px;"></div>

                            <div class="mt-10">
                                <button type="button" class="genric-btn"
                                        style="width: 100%; height: 45px; border-radius: 5px; background-color: #FEE500;border: none;font-size: medium;margin-top: 12px;">
                                    <i class="fa-solid" aria-hidden="true"> </i>KAKAO
                                </button>
                            </div>
                            <div class="mt-10">
                                <button type="button" class="genric-btn"
                                        style="width: 100%; height: 45px; border-radius: 5px; background-color: #dfdfdf;border: none;font-size: medium;margin-top: 12px;">
                                    <i class="fa-solid" aria-hidden="true">
                                    </i> GOOGLE
                                </button>
                            </div>
                            <div class="mt-10">
                                <button type="button" class="genric-btn"
                                        style="width: 100%; height: 45px; border-radius: 5px; background-color: #fff;border: none;font-size: medium;margin-top: 12px; border: 2px solid darkgray">
                                    <i class="fa-brands fa-github" aria-hidden="true"></i> GITHUB
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDxyl3YRLT1FmO3Cjfv-W8PrrWZMYiq1no",
        authDomain: "toty-6d4b4.firebaseapp.com",
        projectId: "toty-6d4b4",
        storageBucket: "toty-6d4b4.firebasestorage.app",
        messagingSenderId: "846986079585",
        appId: "1:846986079585:web:59f9c7a2e75b48ca91a920",
        measurementId: "G-3TRGZCLRG8"
    };

    const VAPID_KEY = "BGORj8XCPGAZQRStC5eQq4I_c1JFd9QHwx0iKmMmL2QJbx4JAIRQH4uwba-KbZDpCWZOoPTZktgT02eF6BYYie0";
    const firebaseApp = initializeApp(firebaseConfig);
    const messaging = getMessaging(firebaseApp);

    // Service Worker 등록 함수
    async function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                console.log('[FCM] Service Worker 등록 성공:', registration);
                return registration;
            } catch (error) {
                console.error('[FCM] Service Worker 등록 실패:', error);
                return null;
            }
        }
        return null;
    }

    // 페이지 로드 확인
    console.log('[LOGIN] 로그인 페이지 스크립트 로드됨');

    // 폼 요소 확인
    const loginForm = document.getElementById('logInForm');
    console.log('[LOGIN] 로그인 폼 찾기:', loginForm);

    if (!loginForm) {
        console.error('[LOGIN] logInForm을 찾을 수 없습니다!');
    } else {
        // 로그인 폼 제출 시 FCM 토큰 등록
        loginForm.addEventListener('submit', async function(e) {
            console.log('[LOGIN] 폼 제출 이벤트 발생!');
            e.preventDefault();

            const formData = new FormData(this);
            const email = formData.get('email');
            const pwd = formData.get('pwd');

            console.log('[LOGIN] 이메일:', email);
            console.log('[LOGIN] 비밀번호 입력 여부:', pwd ? '입력됨' : '입력 안됨');

            if (!email || !pwd) {
                alert('이메일과 비밀번호를 모두 입력해주세요.');
                return;
            }

            try {
                console.log('[LOGIN] 로그인 요청 시작...');

                // 로그인 요청 - redirect: 'follow'로 변경하여 자동으로 리다이렉트 따라가기
                const loginResponse = await fetch('/api/users/sign-in', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ email, pwd }),
                    credentials: 'include' // 쿠키 포함
                });

                console.log('[LOGIN] ========== 응답 정보 ==========');
                console.log('[LOGIN] 응답 상태:', loginResponse.status);
                console.log('[LOGIN] 응답 statusText:', loginResponse.statusText);
                console.log('[LOGIN] 응답 OK 여부:', loginResponse.ok);
                console.log('[LOGIN] 응답 URL:', loginResponse.url);

                // 로그인 실패 페이지로 리다이렉트된 경우
                if (loginResponse.url && loginResponse.url.includes('login-fail')) {
                    console.error('[LOGIN] ========== 로그인 실패 감지 ==========');
                    console.error('[LOGIN] 최종 URL:', loginResponse.url);
                    alert('로그인에 실패했습니다.\n이메일과 비밀번호를 확인해주세요.');
                    return;
                }

                // 로그인 성공 (home으로 리다이렉트됨)
                if (loginResponse.url && loginResponse.url.includes('/view/users/home')) {
                    console.log('[LOGIN] 로그인 성공! 홈으로 리다이렉트 예정');

                    // Service Worker 등록 (선택사항 - FCM 사용 시)
                    try {
                        const swRegistration = await registerServiceWorker();

                        if (swRegistration) {
                            // 알림 권한 요청
                            const permission = await Notification.requestPermission();
                            if (permission === 'granted') {
                                console.log('[FCM] 알림 권한 허용됨');

                                try {
                                    // FCM 토큰 가져오기 (Service Worker 등록 후)
                                    const fcmToken = await getToken(messaging, {
                                        vapidKey: VAPID_KEY,
                                        serviceWorkerRegistration: swRegistration
                                    });

                                    if (fcmToken) {
                                        console.log('[FCM] 토큰 발급 성공');

                                        // 백엔드에 토큰 등록
                                        await fetch('/api/fcm/token', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ token: fcmToken })
                                        });

                                        console.log('[FCM] 토큰 등록 완료');
                                    }
                                } catch (fcmError) {
                                    console.error('[FCM] 토큰 발급 실패:', fcmError);
                                    // FCM 오류가 있어도 로그인은 계속 진행
                                }
                            } else {
                                console.log('[FCM] 알림 권한 거부됨');
                            }
                        }
                    } catch (swError) {
                        console.error('[FCM] Service Worker 등록 실패:', swError);
                        // Service Worker 오류가 있어도 로그인은 계속 진행
                    }

                    // 홈으로 리다이렉트
                    console.log('[LOGIN] 홈으로 리다이렉트...');
                    window.location.href = '/view/users/home';
                    return;
                }

                // 예상치 못한 응답
                console.error('[LOGIN] ========== 예상치 못한 응답 ==========');
                console.error('[LOGIN] 최종 URL:', loginResponse.url);
                console.error('[LOGIN] 상태 코드:', loginResponse.status);
                alert('로그인 처리 중 문제가 발생했습니다.');
            } catch (error) {
                console.error('[LOGIN] 로그인 처리 중 오류:', error);
                console.error('[LOGIN] 오류 스택:', error.stack);
                alert('로그인 처리 중 오류가 발생했습니다: ' + error.message);
            }
        });

        console.log('[LOGIN] 이벤트 리스너 등록 완료');

        // 로그인 버튼에도 직접 클릭 이벤트 추가 (디버깅용)
        const loginBtn = document.getElementById('logInBtn');
        if (loginBtn) {
            loginBtn.addEventListener('click', function(e) {
                console.log('[LOGIN] 로그인 버튼 클릭됨!');
            });
        }
    }
</script>
</body>
</html>